---
title: "Dating the selection"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.retina = 2)
```

iHS and XP-EHH are designed to detect recent selective sweep based on long range haplotypes that lost diversity due to selection but had not been shift by recombination in short time period. We attempted to estimate the time to when selection started at those beneficial allele in inshore population. Because of linkage disequilibrium, it is unlikely to know the exact causal allele in long range haplotypes. We chose to use the loci with peak values in iHS and XP-EHH test.

```{r}
ihs <- read_tsv("data/hpc/selection2/ihs/inshore.ihs.50bins.norm.50kb.windows", col_names = c("chr","start","end","ihs_nsnp","frac","percentile","sd")) %>% filter(percentile==1)

xpehh <- read_tsv("data/hpc/selection2/xpehh/inshore_vs_offshore.xpehh.norm.50kb.windows", col_names = c("chr","start","end","xpehh_nsnp","fracA","fracB","percentileA","percentileB","max","min")) %>% filter(percentileA==1)

xpehh_site <- read_tsv("data/hpc/selection2/xpehh/inshore_vs_offshore.xpehh.norm", col_names = c("chr","pos","norm_xpehh")) 

temp_tb <- ihs %>% full_join(xpehh) %>% mutate(sig=case_when(is.na(ihs_nsnp)~"XP-EHH", is.na(xpehh_nsnp)~"iHS")) %>% mutate(sig=ifelse(is.na(sig),"iHS/XP-EHH",sig)) %>% select(chr,start,end,frac,max,sig) %>% arrange(sig) %>% left_join(xpehh_site) %>% filter(pos>=start & pos<=end) %>% group_by(chr,start,end) %>% mutate(max_pos=pos[which.max(norm_xpehh)], max_xpehh=max(norm_xpehh)) %>% select(-c(pos,norm_xpehh,max)) %>% unique %>% ungroup

ihs_site <- read_tsv("data/hpc/selection2/ihs/inshore.ihs.50bins.norm",col_names = c("chr","pos","norm_ihs"))

peak_snp<- temp_tb %>% left_join(ihs_site) %>% filter(pos>=start & pos<=end) %>% group_by(chr,start,end) %>% mutate(norm_ihs=abs(norm_ihs)) %>% 
  mutate(max_ihs_pos=pos[which.max(norm_ihs)], max_ihs=max(norm_ihs)) %>% select(-c(pos,norm_ihs)) %>% unique 
write_tsv(peak_snp,"../tables/peak_snp.txt")
```




