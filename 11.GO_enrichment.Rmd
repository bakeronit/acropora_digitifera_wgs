---
title: "Gene Ontology Enrichment analysis"
output: 
  github_document:
bibliography: bibliography.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.retina = 2)
library(tidyverse)
library(RColorBrewer)
require(topGO)
require(ggsci)
library(aplot)
library(ape)
library(GO.db)
library(ggtree)
library(ggstance)
library(cowplot)
```


```{r}
uniprot_gene_annot <- read_tsv("data/hpc/annotation/uniprot_gene_annot.tsv") %>% 
  mutate(go=go_ipr) %>% 
  dplyr::select(-go_ipr)

candidate_regions_table <- read_rds("cache/candidate_regions_genes_ehh.rds")

candidate_genes_table <- candidate_regions_table %>% 
  separate_rows(genes,sep=";") %>% 
  left_join(uniprot_gene_annot, by = c("genes"="geneid") )
```

In a previous analysis (see [10.identify_selective_genomic_windows](10.identify_selective_genomic_windows.md) we identified a total of `r nrow(candidate_regions_table)` candidate selective sweep regions.  A summary of sweep regions and the number of genes covered by them in each population is shown below;

```{r}
candidate_genes_table %>% 
  mutate(region_id = paste(chr,start,end,collapse = "_")) %>% 
  group_by(pop) %>% 
  summarise(numgenes = n(), nregions = length(unique(region_id))) %>% 
  knitr::kable()
```

We then used `topGO` to identify GO terms that were enriched in the gene sets covered by selective sweeps in each population. Enrichment was initially calculated in a gene centric manner because GO terms are most properly interpreted as attached to genes not regions, however, since genomic regions and not genes are the independent units in this analysis we then recalculated enrichment statistics in a region centric manner for all GO terms found to be enriched in the initial analysis.  The gene centric analysis considered each gene as an independent entity and considered the target set as the set of all genes intersecting with selective sweeps in a given population, and the background set was taken as the complete set of annotated genes for *A. digitifera*.  The region centric analysis considered the target set as all candidate sweeps for a population and the background set as the complete set of all 50kb regions on which EHH statistics were calculated.

```{r define-functions-regions}
regions_genes_go <- read_rds("cache/all_regions_genes.rds") %>% 
  unite("region_id",chr,start,end) %>% 
  left_join(uniprot_gene_annot,by="geneid")

regions2go <- regions_genes_go %>% 
  group_by(region_id) %>%
  summarise(go = paste(go,sep=";")) %>% 
  split(.$region_id) %>% 
  purrr::map(~str_split(.$go,";") %>% pluck(1) %>% str_trim() %>% unique())
```


```{r define-functions-genes}
gene2go <- uniprot_gene_annot %>% 
  split(.$geneid) %>% 
  purrr::map(~str_split(.$go,";") %>% pluck(1) %>% str_trim())

go2gene <- uniprot_gene_annot %>% 
  dplyr::select(geneid,go) %>% 
  separate_rows(go,sep=";") %>% 
  mutate(go=str_trim(go)) %>% 
  group_by(go) %>%
  split(.$go) %>% 
  purrr::map( ~.$geneid)

go_enrich_topgo <- function(targets,onto) {
    genenames <- names(gene2go)
    genelist <- factor(as.integer(genenames %in% targets))
    names(genelist) <- genenames

    GOdata <- new("topGOdata",
                  allGenes = genelist,
                  annot=annFUN.gene2GO,
                  gene2GO=gene2go,
                  ontology=onto,
                  nodeSize=10)
    
    resultFisher <- runTest(GOdata, 
                        algorithm = "weight01",
                        statistic = "fisher")

    gt <- GenTable(GOdata,classic=resultFisher,
                   WeightFisher=resultFisher,
                   orderBy = "WeightFisher",
                   topNodes=150)
    list(godata= GOdata, result=resultFisher, table=gt)
}

genes_in_enrichedGO <- function(topgo_results,target) {
  topgo_results$table %>% 
    mutate(classic=as.numeric(classic),
           WeightFisher=as.numeric(WeightFisher)) %>%
    dplyr::select(GO.ID) %>% pull %>% 
    map_df(~genesInTerm(object = topgo_results$godata,whichGO = .x)) %>%
    pivot_longer(cols = everything(),names_to = "go",values_to = "geneid") %>% 
    na.omit() %>% 
    filter(geneid %in% target)
}

go_enrich_all_ontologies <- function(genes_table,target_pop){
  target <- genes_table %>% 
    filter(pop==target_pop) %>% 
    dplyr::select(genes) %>% 
    distinct %>% 
    pull

  mf <- go_enrich_topgo(targets = target,onto = "MF")
  bp <- go_enrich_topgo(targets = target,onto = "BP")
  cc <- go_enrich_topgo(targets = target,onto = "CC")

  all_results <- list("MF"=mf,"BP"=bp,"CC"=cc)
  all_results_genes <- map_dfr(all_results,genes_in_enrichedGO,target) %>% 
    left_join(uniprot_gene_annot %>%
                dplyr::select(geneid,uniprot_id,protein)) %>%
    group_by(go) %>% 
    summarise(uniprot_ids = paste(unique(uniprot_id),collapse = ";"), 
                geneids = paste(unique(geneid),collapse = ";"),
                protein_names = paste(unique(protein),collapse = ";"))
  
  all_onto <- rbind(bp$table %>% mutate(classic=as.numeric(classic),WeightFisher=as.numeric(WeightFisher)) %>% add_column(ontology="BP"), 
                    mf$table %>% mutate(classic=as.numeric(classic),WeightFisher=as.numeric(WeightFisher)) %>% add_column(ontology="MF"),
                    cc$table %>% mutate(classic=as.numeric(classic),WeightFisher=as.numeric(WeightFisher)) %>% add_column(ontology="CC"))
  all_onto %>% 
    left_join(all_results_genes,by=c("GO.ID"="go")) 
}
```


```{r}
if ( !file.exists("cache/topgo_results_all.rds") ){
  inshore_topgo <- go_enrich_all_ontologies(candidate_genes_table,"inshore") %>% add_column(pop="inshore")
  northoffshore_topgo <- go_enrich_all_ontologies(candidate_genes_table,"northoffshore") %>% add_column(pop="northoffshore")
  southoffshore_topgo <- go_enrich_all_ontologies(candidate_genes_table,"southoffshore") %>% add_column(pop="southoffshore")

  topgo_results_all <- rbind(inshore_topgo,northoffshore_topgo,southoffshore_topgo)
  write_rds(topgo_results_all,"cache/topgo_results_all.rds")
  write_tsv(topgo_results_all,"cache/topgo_results_all.tsv") # This table should be in Supp Info

  # dated_loci <- read_rds("cache/dated_loci.rds")
  # dated_inshore_topgo <- candidate_genes_table %>% unite("locus_id",chr,start,end,remove=FALSE) %>% filter(locus_id %in% names(dated_loci)) %>% go_enrich_all_ontologies("inshore")
  # dated_northoffshore_topgo <- candidate_genes_table %>% unite("locus_id",chr,start,end,remove=FALSE) %>% filter(locus_id %in% names(dated_loci)) %>% go_enrich_all_ontologies("northoffshore")  
  # dated_southoffshore_topgo <- candidate_genes_table %>% unite("locus_id",chr,start,end,remove=FALSE) %>% filter(locus_id %in% names(dated_loci)) %>% go_enrich_all_ontologies("southoffshore")

  } else {
  topgo_results_all <- read_rds("cache/topgo_results_all.rds")
}
```


```{r}
jaccard <- function(a, b) {
    1-(length(intersect(a, b))/length(union(a,b)))
}


jaccard_go <- function(terms1){
  jaccard(terms1[[1]],terms1[[2]])
}

display_go <- topgo_results_all %>% 
  filter(Significant>0) %>% 
  pull(GO.ID) %>% 
  unique()

go2gene_signif <- topgo_results_all %>%
  filter(GO.ID %in% display_go) %>%
  dplyr::select(GO.ID,geneids) %>%
  separate_rows(geneids,sep=";") %>% 
  filter(!is.na(geneids)) %>% 
  filter(geneids!="NA") %>% 
  group_by(GO.ID) %>% 
  summarise(geneids=paste(unique(geneids),collapse = ";")) %>% 
  ungroup() %>% 
  split(.$GO.ID) %>%
  purrr::map(~ .$geneids %>% str_split(";") %>% pluck(1))



if ( !file.exists("cache/jdm.rds")){
  cx <- cross2(go2gene_signif,go2gene_signif) #
  jdm <- cx %>% 
    map_dbl(jaccard_go) %>% 
    matrix(nrow=length(go2gene_signif))
  write_rds(jdm,"cache/jdm.rds")
} else {
  jdm <- read_rds("cache/jdm.rds")
}

rownames(jdm) <- names(go2gene_signif)
colnames(jdm) <- names(go2gene_signif)
```

We found a total of `r length(display_go)` GO terms enriched (p<0.001) across all three of the locations.  These are summarised in Figure 1.  

```{r, fig.height=12}
n_regions_per_term <- function(term,focal_pop){
  candidate_regions_table %>%
  unite("region_id",chr,start,end,remove=FALSE) %>% 
  separate_rows(genes,sep=";") %>% 
  filter(genes %in% (go2gene_signif[term] %>% pluck(1))) %>% 
    filter(pop==focal_pop) %>% 
    pull(region_id) %>% n_distinct()
}

n_genes_per_term <- function(term,focal_pop){
  candidate_regions_table %>%
    filter(pop==focal_pop) %>% 
    separate_rows(genes,sep=";") %>% 
    filter(genes %in% (go2gene_signif[term] %>% pluck(1))) %>% 
    pull(genes) %>% n_distinct()
}

n_regions_bg_per_term <- function(term){
  regions_genes_go %>% 
    dplyr::select(region_id,geneid) %>% 
    filter(geneid %in% (go2gene_signif[term] %>% pluck(1))) %>% 
    n_distinct()
}

enrich_test <- function(n_regions,n_regions_sig,n_regions_ann,n_regions_ann_sig){
  dat <- data.frame(
  "non_signif" = c(n_regions_ann-n_regions_ann_sig, n_regions-n_regions_ann),
  "signif" = c(n_regions_ann_sig, n_regions_sig-n_regions_ann_sig),
  row.names = c("Annotated", "Non-Annotated"),
  stringsAsFactors = FALSE
  )
  colnames(dat) <- c("Non_Sig", "Sig")
  test <- fisher.test(dat)
  test$p.value
}


number_of_sig_regions <- candidate_regions_table %>% 
  group_by(pop) %>% 
  summarise(n_sig = n()) %>% 
  pull(n_sig,name = pop)

total_bg_regions <- regions_genes_go$region_id %>% n_distinct()

bar_go1 <- topgo_results_all %>% 
  group_by(GO.ID) %>% 
  summarise(max_sig=max(Significant),minwf=min(WeightFisher)) %>% 
  filter(max_sig>0) %>% 
  filter(minwf<0.001) %>% 
  pull(GO.ID) %>% 
  unique()


bar_go <- topgo_results_all %>% 
  filter(GO.ID %in% bar_go1) %>%
  rowwise() %>% 
  mutate(n_regions = map2_int(GO.ID,pop,n_regions_per_term)) %>% 
  group_by(GO.ID) %>% 
  summarise(max_regions = max(n_regions)) %>% 
  filter(max_regions>2) %>% 
  pull(GO.ID) %>% 
  unique()

pg_go1 <- topgo_results_all %>% 
  filter(GO.ID %in% bar_go) %>% 
  mutate(n_regions = map2_int(GO.ID,pop,n_regions_per_term),
         n_region_bg = map_int(GO.ID,n_regions_bg_per_term),
         n_region_expected = number_of_sig_regions[pop]*n_region_bg/total_bg_regions) %>% 
  mutate(p.region = pmap_dbl(list(total_bg_regions,number_of_sig_regions[pop],n_region_bg,n_regions),enrich_test)) 

pg_go <- pg_go1 %>% 
  pivot_wider(id_cols = c("GO.ID","ontology"), names_from = pop,values_from = p.region,values_fill = NA) %>% 
  pivot_longer(c(inshore,northoffshore,southoffshore),names_to = "pop", values_to = "p.region") %>% 
  left_join(pg_go1) %>% 
  rowwise() %>% 
  mutate(Significant = ifelse(is.na(Significant), n_genes_per_term(GO.ID,pop),Significant )) %>% 
  mutate(n_regions = ifelse(is.na(n_regions), n_regions_per_term(GO.ID,pop),n_regions)) %>% 
  mutate(n_region_bg = ifelse(is.na(n_region_bg), n_regions_bg_per_term(GO.ID), n_region_bg)) %>% 
  mutate(p.region = ifelse(is.na(p.region), enrich_test(total_bg_regions, number_of_sig_regions[pop],n_region_bg, n_regions), p.region)) 
```


```{r, fig.height=12}
pop_names <- c("inshore"="Inshore","northoffshore"="North Offshore","southoffshore"="South Offshore")

library(colorspace)
hclcols <- sequential_hcl(3,palette = "ag_Sunset")

barplot <- pg_go %>% 
  mutate(pop_names=pop_names[pop]) %>% 
  mutate(text_label = paste(Significant,"/",n_regions,sep = "")) %>% 
  mutate(is_enriched = ifelse(p.region<0.001, 1, 0.3)) %>% 
  ggplot(aes(x=-log10(classic),y=GO.ID,fill=ontology)) + 
  geom_col(aes(alpha=is_enriched)) +
#  ggstance::geom_colh(aes(alpha=is_enriched)) +
#  scale_fill_grey() +
  scale_fill_manual(values = hclcols,labels = c("Biological process", "Cellular component", "Molecular function")) +
  geom_text(aes(label=text_label), hjust=-0.1,size=2) +
  theme_bw() + 
  guides(alpha="none") +
  labs(x=expression(-Log[10](P)),y="",fill="") +
  theme(panel.grid = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=6),
        axis.title.x = element_text(size=6),
        strip.text = element_text(size=6),
        strip.background = element_blank()) + 
  ylab("") + 
  facet_wrap(~pop_names) +
  xlim(0,15)

leg_b <- get_legend(barplot)

go_terms = AnnotationDbi::select(GO.db, keys(GO.db, "GOID"), c("TERM", "ONTOLOGY")) %>% 
  filter(GOID %in% display_go)



tree_data <- pg_go %>% 
  pivot_wider(id_cols = c("GO.ID","ontology"), names_from = pop, values_from = classic) %>% 
  dplyr::rename(inshore_p = inshore, northoffshore_p = northoffshore, southoffshore_p = southoffshore) %>% 
  left_join(pg_go %>% pivot_wider(id_cols = c("GO.ID"), names_from = pop, values_from = Significant)) %>% 
  as.data.frame() %>% 
  left_join(go_terms,by=c("GO.ID"="GOID")) %>% 
  mutate(term_label = paste(GO.ID," ",TERM,sep=""))

jdm_included <- jdm[tree_data$GO.ID,tree_data$GO.ID]
hc <- hclust(as.dist(jdm_included))
hc_order <- hc$order
names(hc_order) <- rownames(jdm_included)[hc$order]

#hcp <- as.phylo(hc)

tree <- ggtree(as.phylo(hc)) %<+% tree_data + 
geom_tiplab(aes(label = term_label),align = TRUE, size=2) + 
  xlim(0,10) 

bpt <- (barplot + theme(legend.position = "none")) %>% insert_left(tree, width = 1.2)
ggsave(bpt,filename = "figures/go_enrichment_wide.png",height = 3,width = 6.75)
leg_b <- ggdraw(leg_b)
ggsave(leg_b,filename = "figures/go_legend.png",width = 6.75,height = 1)


# plot_grid(bpt, leg_b, ncol=1, rel_heights =c(.9, .1))
# ggsave(filename = "figures/go_enrichment_wide.png",height = 3,width = 6.75)

#ggsave(bpt,filename = "figures/go_enrichment.png",height = 6,width = 9.5)
bpt
```

**Figure 1: Enriched GO terms for genes intersecting with candidate loci under selection**. Length of bars indicates significance (longer is more significant) and colour indicates the ontology. Numerical labels indicate the number of genes putatively under selection. Dendrogram depicts relationships between GO terms based on numbers of shared annotated genes.  


```{r}
gene_table_for_term <- function(goterm){
  candidate_regions_table %>%
  unite("region_id",chr,start,end,remove=FALSE) %>% 
  separate_rows(genes,sep=";") %>% 
  filter(genes %in% (go2gene_signif[goterm] %>% pluck(1))) %>% 
  left_join(uniprot_gene_annot,by=c("genes"="geneid")) %>% 
  ungroup() %>% 
    add_column(enriched_go=goterm) %>% 
    dplyr::select(enriched_go,region_id,pop,genes,entryname,genename,protein,frac,stats) %>% 
    na.omit()
}

rth_genes <- gene_table_for_term("GO:0009408")
```

```{r}
go_terms_in_plot <- jdm_included %>% rownames()

allgo_genes <- map_dfr(go_terms_in_plot,gene_table_for_term) %>% 
  left_join(go_terms,by=c("enriched_go"="GOID")) %>% 
  dplyr::select(enriched_go,TERM,region_id,pop,genes,entryname,genename,protein,frac,stats)

write_tsv(allgo_genes,"cache/allgo_genes.tsv")
```


